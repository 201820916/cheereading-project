{% extends "base.html" %}

{% block title %}{{ book.title }}{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        {# --- ì™¼ìª½ ì»¬ëŸ¼: ì±… í‘œì§€ ë° ë…ì í†µê³„ --- #}
        <div class="col-md-4">
            {% if book.cover_image_url %}
                <img src="{{ book.cover_image_url }}" alt="{{ book.title }} í‘œì§€" class="img-fluid rounded shadow-sm mb-4">
            {% else %}
                <div class="no-image mb-4" style="width:100%; height:450px; background-color:#eee; display:flex; align-items:center; justify-content:center; border-radius:8px;">No Image</div>
            {% endif %}

            {% if total_readers > 1 %}
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="card-title text-center text-muted mb-3">ğŸ“Š ì´ ì±…ì„ ì½ì€ ë…ì í†µê³„</h6>
                    <div id="readerStatsCarousel" class="carousel slide">
                        <div class="carousel-inner">
                            <div class="carousel-item active">
                                <h6 class="text-center small">ì„±ë³„ ë¶„í¬</h6>
                                <canvas id="genderDistributionChart" style="max-height: 200px;"></canvas>
                            </div>
                            <div class="carousel-item">
                                <h6 class="text-center small">ì—°ë ¹ëŒ€ ë¶„í¬</h6>
                                <canvas id="ageDistributionChart" style="max-height: 200px;"></canvas>
                            </div>
                        </div>
                        <button class="carousel-control-prev stats-carousel-control" type="button" data-bs-target="#readerStatsCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        </button>
                        <button class="carousel-control-next stats-carousel-control" type="button" data-bs-target="#readerStatsCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        </button>
                    </div>
                    <div class="text-center mt-2">
                        <small class="text-muted">ì´ {{ total_readers }}ëª…ì´ ì½ì—ˆìŠµë‹ˆë‹¤.</small>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="card shadow-sm">
                <div class="card-body text-center text-muted p-4">
                    <p class="mb-0">ë” ë§ì€ ë…ìë“¤ì´ ì´ ì±…ì„ ì½ìœ¼ë©´<br>í†µê³„ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>
            </div>
            {% endif %}
        </div>

        {# --- ì˜¤ë¥¸ìª½ ì»¬ëŸ¼: ì±… ì •ë³´, ë²„íŠ¼, ë¦¬ë·° ë“± --- #}
        <div class="col-md-8">
            <h2>{{ book.title }}</h2>
            <p class="meta">
                <strong>ì €ì:</strong> {{ book.author|default:"ì •ë³´ ì—†ìŒ" }} <br>
            </p>
            <p class="description">
                {{ book.summary|linebreaksbr|default:"ì±… ì†Œê°œê°€ ì—†ìŠµë‹ˆë‹¤." }}
            </p>

            {# â–¼â–¼â–¼ [ìˆ˜ì •] ì¤‘ë³µëœ ì±… ì •ë³´ ë¸”ë¡ ì‚­ì œ â–¼â–¼â–¼ #}
            
            {# --- ì„œì¬/ìœ„ì‹œë¦¬ìŠ¤íŠ¸ ë²„íŠ¼ --- #}
            <div class="my-4 book-actions">
                {% if user.is_authenticated %}
                    {% if is_in_library %}
                        <form action="{% url 'books:delete_reading_entry' user_review.id %}" method="POST" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-secondary me-2">
                                    <i class="bi bi-journal-check"></i> ë‚´ ì„œì¬ì—ì„œ ì œê±°
                                </button>
                            </form>
                        {% else %}
                         <a href="{% url 'books:add_reading_entry' book.id %}" class="btn btn-success me-2"><i class="bi bi-journal-plus"></i> ë‚´ ì„œì¬ì— ì¶”ê°€</a>
                    {% endif %}

                    {% if is_in_wishlist %}
                         <form action="{% url 'books:remove_from_wishlist' book.id %}" method="POST" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-outline-danger"><i class="bi bi-heart-fill"></i> ìœ„ì‹œë¦¬ìŠ¤íŠ¸ ì œê±°</button>
                         </form>
                    {% else %}
                        <form action="{% url 'books:add_to_wishlist' book.id %}" method="POST" class="d-inline">
                           {% csrf_token %}
                           <button type="submit" class="btn btn-danger"><i class="bi bi-heart"></i> ìœ„ì‹œë¦¬ìŠ¤íŠ¸ ì¶”ê°€</button>
                        </form>
                    {% endif %}
                {% else %}
                    <p class="text-muted">ë¡œê·¸ì¸ í›„ ì„œì¬ ë° ìœ„ì‹œë¦¬ìŠ¤íŠ¸ ê¸°ëŠ¥ì„ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                {% endif %}
            </div>

            <hr> {# ë²„íŠ¼ê³¼ ë¦¬ë·° ì„¹ì…˜ êµ¬ë¶„ #}

            {# --- ë‚´ ë¦¬ë·° ì„¹ì…˜ --- #}
            <div class="my-4">
                <div class="my-review">
                    <h4>ğŸ“ ë‚´ ë¦¬ë·°</h4>
                    <div class="card shadow-sm">
                        <div class="card-body">
                            {% if user.is_authenticated %}
                                {% if user_review %}
                                    <h5 class="card-title">ë³„ì : {{ user_review.rating }}/5</h5>
                                    <div class="review-content-wrapper">
                                        <div class="review-content short-review active">
                                            <p class="card-text"><strong>{{ user_review.review }}</strong></p>
                                        </div>
                                        {% if user_review.detailed_review %}
                                        <div class="review-content detailed-review">
                                            <p class="card-text text-muted">{{ user_review.detailed_review|linebreaksbr }}</p>
                                        </div>
                                        {% endif %}
                                    </div>
                                    <small class="text-muted">{{ user_review.read_date|date:"Y-m-d" }} ì‘ì„±</small>
                                    <div class="mt-2">
                                        <a href="{% url 'books:edit_reading_entry' entry_id=user_review.id %}" class="btn btn-sm btn-outline-secondary">ìˆ˜ì •</a>
                                        <form action="{% url 'books:delete_reading_entry' user_review.id %}" method="POST" class="d-inline" onsubmit="return confirm('ì •ë§ë¡œ ì´ ë¦¬ë·°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-sm btn-outline-danger">ì‚­ì œ</button>
                                        </form>
                                        {% if user_review.detailed_review %}
                                        <button class="btn btn-sm btn-outline-info toggle-review-btn">ìƒì„¸í‰ ë³´ê¸°</button>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    {% if is_in_library %}
                                        <p class="text-muted">ì•„ì§ ì´ ì±…ì— ëŒ€í•œ ë¦¬ë·°ë¥¼ ì‘ì„±í•˜ì§€ ì•Šìœ¼ì…¨ìŠµë‹ˆë‹¤.</p>
                                        <a href="{% url 'books:add_reading_entry' book.id %}" class="btn btn-sm btn-primary">ë¦¬ë·° ì‘ì„±í•˜ê¸°</a>
                                    {% else %}
                                        <div class="card-body d-flex align-items-center justify-content-center">
                                            <p class="text-muted mb-0">ë‚´ ì„œì¬ì— ì¶”ê°€í•œ ì±…ë§Œ ë¦¬ë·°ë¥¼ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                                        </div>
                                    {% endif %}
                                {% endif %}
                            {% else %}
                                <p class="text-muted">ë¡œê·¸ì¸ í›„ ë‚´ ë¦¬ë·°ë¥¼ í™•ì¸í•˜ê±°ë‚˜ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <hr class="mt-5">
{# â–¼â–¼â–¼ ë‹¤ë¥¸ ì‚¬ìš©ì ë¦¬ë·° ì„¹ì…˜ ì¶”ê°€ â–¼â–¼â–¼ #}
            <div class="all-reviews-section mt-4">
                <h4>ğŸ‘¥ ë‹¤ë¥¸ ì‚¬ìš©ìë“¤ì˜ ë¦¬ë·°</h4>
                {% if other_reviews %}
                    {% for review in other_reviews %}
                        <div class="card shadow-sm mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <strong>{{ review.user.nickname|default:review.user.username }}</strong>
                                    <small class="text-muted">{{ review.read_date|date:"Y.m.d" }}</small>
                                </div>
                                <div class="mb-2">
                                    {# ë³„ì  í‘œì‹œ #}
                                    {% for i in "12345" %}
                                        <i class="bi {% if i|add:0 <= review.rating %}bi-star-fill text-warning{% else %}bi-star{% endif %}"></i>
                                    {% endfor %}
                                </div>
                                <p class="card-text">{{ review.review }}</p>
                                
                                {# ìƒì„¸í‰ì´ ìˆëŠ” ê²½ìš° í‘œì‹œ #}
                                {% if review.detailed_review %}
                                    <div class="detailed-review-content text-muted small mt-2" style="border-left: 3px solid #eee; padding-left: 10px;">
                                        {{ review.detailed_review|linebreaksbr }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="card shadow-sm">
                        <div class="card-body text-center text-muted">
                            <p class="mb-0">ì•„ì§ ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                    </div>
                {% endif %}
            </div>
            {# â–²â–²â–² ë‹¤ë¥¸ ì‚¬ìš©ì ë¦¬ë·° ì„¹ì…˜ ì¶”ê°€ â–²â–²â–² #}

        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{{ gender_labels|json_script:"gender-labels-data" }}
{{ gender_data|json_script:"gender-data-data" }}
{{ age_labels|json_script:"age-labels-data" }}
{{ age_data|json_script:"age-data-data" }}

<style>
    .stats-carousel-control { width: 15%; }
    .stats-carousel-control .carousel-control-prev-icon,
    .stats-carousel-control .carousel-control-next-icon {
        background-color: rgba(0, 0, 0, 0.3);
        border-radius: 50%;
        width: 1.5rem;
        height: 1.5rem;
    }

    .review-content {
        display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ëª¨ë“  ë¦¬ë·° ë‚´ìš©ì€ ìˆ¨ê¹€ */
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }
    .review-content.active {
        display: block; /* active í´ë˜ìŠ¤ê°€ ë¶™ì€ ë‚´ìš©ë§Œ ë³´ì—¬ì¤Œ */
        opacity: 1;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    try {
        const genderCtx = document.getElementById('genderDistributionChart');
        if (genderCtx) {
            const genderLabels = JSON.parse(document.getElementById('gender-labels-data').textContent);
            const genderData = JSON.parse(document.getElementById('gender-data-data').textContent);
            if (genderData.length > 0) {
                new Chart(genderCtx, {
                    type: 'doughnut',
                    data: {
                        labels: genderLabels,
                        datasets: [{ data: genderData, backgroundColor: ['#4A6253', '#A8998A', '#D4C8BC'], borderColor: '#fff', borderWidth: 2 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } } }
                });
            }
        }

        const ageCtx = document.getElementById('ageDistributionChart');
        if (ageCtx) {
            const ageLabels = JSON.parse(document.getElementById('age-labels-data').textContent);
            const ageData = JSON.parse(document.getElementById('age-data-data').textContent);
            if (ageData.length > 0) {
                new Chart(ageCtx, {
                    type: 'bar',
                    data: {
                        labels: ageLabels,
                        datasets: [{ label: 'ì¸ì›', data: ageData, backgroundColor: 'rgba(125, 110, 99, 0.6)', borderWidth: 0 }]
                    },
                    options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } }
                });
            }
        }
    } catch (e) {
        console.error("Chart rendering error:", e);
    }

    const toggleButtons = document.querySelectorAll('.toggle-review-btn');

    toggleButtons.forEach(button => {
        button.addEventListener('click', function() {
            // í´ë¦­ëœ ë²„íŠ¼ì´ ì†í•œ ì¹´ë“œ(card-body)ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
            const cardBody = this.closest('.card-body');
            
            // í•´ë‹¹ ì¹´ë“œ ì•ˆì˜ ì§§ì€ ë¦¬ë·°ì™€ ìƒì„¸ ë¦¬ë·°ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
            const shortReview = cardBody.querySelector('.short-review');
            const detailedReview = cardBody.querySelector('.detailed-review');

            // í˜„ì¬ 'ìƒì„¸í‰ ë³´ê¸°' ìƒíƒœì¸ì§€ í…ìŠ¤íŠ¸ë¡œ í™•ì¸
            const isShowingShortReview = this.textContent === 'ìƒì„¸í‰ ë³´ê¸°';

            if (isShowingShortReview) {
                // ìƒì„¸í‰ ë³´ì—¬ì£¼ê¸°
                shortReview.classList.remove('active');
                detailedReview.classList.add('active');
                this.textContent = '100ìí‰ ë³´ê¸°'; // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
            } else {
                // 100ìí‰ ë³´ì—¬ì£¼ê¸°
                detailedReview.classList.remove('active');
                shortReview.classList.add('active');
                this.textContent = 'ìƒì„¸í‰ ë³´ê¸°'; // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì›ë˜ëŒ€ë¡œ
            }
        });
    });
});
</script>
{% endblock %}